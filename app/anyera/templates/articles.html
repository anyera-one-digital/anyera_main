{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="top" data-scroll-section id="top"></section>
<section class="services_top" data-scroll-section>
  <div class="container services_top__container">
    <div class="services_top__block">
      <ul class="breadcrumbs__list">
        <li class="breadcrumbs__item"><a href="/" class="breadcrumbs__link text">Главная</a></li>
        <li class="breadcrumbs__item"><a href="/articles/" class="breadcrumbs__link text">Медиа</a></li>
      </ul>
      <div class="services_top__info">
        <div class="services_top__left">
          <p class="rubik">МЕДИА</p>
        </div>
        <div class="services_top__right">
          <h1 class="services_top__head title_two">{{ content.title|default:"МЕДИА" }}</h1>
          <div class="services_top__desc">{{ content.description|safe|default:"<p>Рассказываем о digital-трендах и о мире цифровизации. Делимся личным опытом и кейсами.</p>"}}</div> 
        </div>
      </div>
      <div class="articles_page__checks">
        <label class="btn checkbox articles_page__check active"><span class="button__text">Все статьи</span><span class="button__hover"></span><input class="checkbox__input articles_page__check_input" name="type" type="radio" value="" checked=""></label>
        {% for theme in themes %}
        <label class="btn checkbox articles_page__check"><span class="button__text">{{ theme.name }}</span><span class="button__hover"></span><input class="checkbox__input articles_page__check_input" name="type" type="radio" value="{{ theme.id }}"></label>
        {% endfor %}
      </div>
    </div>
  </div>
</section>
<section class="articles_page" data-scroll-section>
  <div class="container articles_page__container">
    <div class="articles_page__divider"></div>
  </div>
  <div class="container articles_page__list_container">
    <ul class="articles__list articles__list_new">
      {% for article in articles %}
      <li class="articles__item animate">
        <a href="/articles/{{ article.code }}" class="articles__link">
          <div class="articles__image">
            <img src="/media/{{ article.preview_img }}" alt="">
            <span class="articles__date">{{ article.created_at }}</span>
          </div>
          <div class="articles__info">
            <h4 class="articles__head">{{ article.title }}</h4>
            <p class="articles__desc">{{ article.preview }}</p>
          </div>
        </a>
      </li>
      {% endfor %}
    </ul>
    <div class="articles_page__bogttom">
      {% if page_obj.has_next %}
        <button class="btn articles_page__button" id="load-more-btn">
          <span class="button__text">Показать еще</span>
          <span class="button__hover"></span>
        </button>
      {% endif %}
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const listEl       = document.querySelector('.articles__list');
    const loadMoreBtn  = document.getElementById('load-more-btn');
    const filters      = document.querySelectorAll('.articles_page__check_input');
  
    let currentTheme = '';
    let nextUrl      = null;
  
    function renderArticles(articles, append = false) {
      if (!append) listEl.innerHTML = '';
      console.log(articles);
      for (const a of articles) {
        const li = document.createElement('li');
        li.className = 'articles__item animate';
        li.innerHTML = `
          <a href="/articles/${a.code}" class="articles__link">
            <div class="articles__image">
              <img src="${a.preview_img}" alt="">
            </div>
            <div class="articles__info">
              <h4 class="articles__head">${a.title}</h4>
              <p class="articles__desc">${a.preview}</p>
            </div>
          </a>`;
        listEl.appendChild(li);
      }
    }
  
    async function loadArticles(url, append = false) {
      try {
        const res  = await fetch(url);
        const data = await res.json();
        renderArticles(data.results, append);
  
        nextUrl = data.next;
  
        if (nextUrl && loadMoreBtn) {
          loadMoreBtn.style.display = '';
        } else if (loadMoreBtn) {
          loadMoreBtn.style.display = 'none';
        }
      } catch (err) {
        console.error('Error loading articles:', err);
      }
    }
  
    function onFilterChange() {
      const checked = [...filters].find(i => i.checked);
      currentTheme = checked ? checked.value : '';
      let url = `/api/v1/articles/?page=1`;
      if (currentTheme) url += `&theme=${currentTheme}`;
      loadArticles(url, false);
    }
  
    filters.forEach(i =>
      i.addEventListener('change', onFilterChange)
    );
    if (loadMoreBtn) {
      loadMoreBtn.addEventListener('click', () => {
        if (nextUrl) {
          loadArticles(nextUrl, true);
        }
      });
    }
  
    onFilterChange();
  });
  </script>
{% endblock %}
